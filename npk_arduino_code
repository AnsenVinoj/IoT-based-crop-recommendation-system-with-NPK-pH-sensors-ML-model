
#include <ModbusMaster.h>
#include <SoftwareSerial.h>

#define DE 2 
#define RE 3  
#define RO 10  
#define DI 11  

SoftwareSerial RS485Serial(RO, DI);
ModbusMaster node;

void preTransmission() {
  digitalWrite(DE, HIGH);
  digitalWrite(RE, HIGH);
}

void postTransmission() {
  digitalWrite(DE, LOW);
  digitalWrite(RE, LOW);
}

void setup() {
  Serial.begin(9600);
  RS485Serial.begin(9600);

  pinMode(DE, OUTPUT);
  pinMode(RE, OUTPUT);
  
  digitalWrite(DE, LOW);
  digitalWrite(RE, LOW);

  node.begin(42, RS485Serial);
  node.preTransmission(preTransmission);
  node.postTransmission(postTransmission);
}

void loop() {
  uint8_t result;
  uint16_t data[3];

  result = node.readHoldingRegisters(0x0003, 3);

  if (result == node.ku8MBSuccess) {
  float data[3];  // Declare the array of 3 elements

  data[0] = node.getResponseBuffer(2);  // N
  data[1] = node.getResponseBuffer(1);  // P
  data[2] = node.getResponseBuffer(0);  // K

  Serial.print(data[0],1); Serial.print(",");
  Serial.print(data[1],1); Serial.print(",");
  Serial.println(data[2],1);
}
 else {
    Serial.println("Error reading sensor");
  }

  delay(500);
}
